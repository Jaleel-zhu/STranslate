<ui:Page
    x:Class="STranslate.Views.Pages.PluginMarketPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:cnvt="clr-namespace:STranslate.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ikw="http://schemas.inkore.net/lib/ui/wpf"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:s="https://github.com/zggsong/2022/xaml"
    xmlns:ui="http://schemas.inkore.net/lib/ui/wpf/modern"
    xmlns:vm="clr-namespace:STranslate.ViewModels.Pages"
    Title="PluginMarket"
    d:DataContext="{d:DesignInstance Type=vm:PluginMarketViewModel,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="600"
    d:DesignWidth="800"
    mc:Ignorable="d">
    <ui:Page.Resources>
        <s:BindingProxy x:Key="ViewModelProxy" Data="{Binding .}" />
    </ui:Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  标题栏  -->
        <DockPanel Grid.Row="0" Margin="20,10,20,12">
            <TextBlock
                DockPanel.Dock="Left"
                Style="{DynamicResource {x:Static ui:ThemeKeys.SubtitleTextBlockStyleKey}}"
                Text="{DynamicResource PluginMarket}" />
            <ikw:SimpleStackPanel
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                DockPanel.Dock="Right"
                Orientation="Horizontal"
                Spacing="10">
                <!--  刷新按钮  -->
                <Button
                    Command="{Binding LoadPluginsCommand}"
                    IsEnabled="{Binding IsLoading, Converter={cnvt:BoolInverseConverter}}"
                    ToolTip="{DynamicResource PluginMarketRefresh}">
                    <ui:FontIcon FontSize="{DynamicResource STControlFontSize16}" Icon="{x:Static ui:FluentSystemIcons.ArrowClockwise_20_Regular}" />
                </Button>
                <!--  分类筛选  -->
                <ComboBox
                    MinWidth="120"
                    DisplayMemberPath="Display"
                    ItemsSource="{Binding DataProvider.PluginTypes}"
                    SelectedValue="{Binding SelectedPluginType}"
                    SelectedValuePath="Value" />
                <!--  搜索框  -->
                <TextBox
                    Width="180"
                    VerticalAlignment="Center"
                    ui:ControlHelper.PlaceholderText="{DynamicResource PluginMarketSearch}"
                    Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" />
            </ikw:SimpleStackPanel>
        </DockPanel>

        <!--  插件列表  -->
        <Border Grid.Row="1" Margin="20,0,20,0">
            <Grid>
                <!--  空状态/加载状态  -->
                <StackPanel
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{Binding IsLoading, Converter={cnvt:BoolToVisibilityConverter}}">
                    <ui:ProgressRing
                        Width="40"
                        Height="40"
                        IsActive="{Binding IsLoading}" />
                    <TextBlock
                        Margin="0,10,0,0"
                        Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}"
                        Text="{Binding LoadingStatus}" />
                </StackPanel>

                <TextBlock
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}"
                    Text="{Binding LoadingStatus}"
                    Visibility="{Binding IsLoading, Converter={cnvt:BoolInverseToVisibilityConverter}}" />

                <!--  插件列表  -->
                <ListBox
                    x:Name="PART_PluginListBox"
                    Background="Transparent"
                    ItemsSource="{Binding PluginsView}"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    Visibility="{Binding IsLoading, Converter={cnvt:BoolInverseToVisibilityConverter}}">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel HorizontalAlignment="Center" IsItemsHost="True" />
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>

                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0,0,12,12" />
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <ContentPresenter />
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>

                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="vm:PluginMarketInfo">
                            <Border
                                Width="280"
                                MinHeight="90"
                                Padding="12"
                                Background="{DynamicResource {x:Static ui:ThemeKeys.CardBackgroundFillColorDefaultBrushKey}}"
                                BorderBrush="{DynamicResource {x:Static ui:ThemeKeys.CardStrokeColorDefaultBrushKey}}"
                                BorderThickness="1"
                                CornerRadius="8">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Opacity" Value="1" />
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource {x:Static ui:ThemeKeys.SystemFillColorAttentionBackgroundBrushKey}}" />
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="10" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <!--  左侧图标  -->
                                    <Image
                                        Grid.Column="0"
                                        Width="32"
                                        Height="32"
                                        VerticalAlignment="Center"
                                        Source="{Binding IconUrl}"
                                        Stretch="Uniform" />

                                    <!--  右侧内容  -->
                                    <Grid Grid.Column="2">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" MinHeight="20" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!--  标题行：名称 + 操作按钮  -->
                                        <Grid Grid.Row="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <TextBlock
                                                Grid.Column="0"
                                                VerticalAlignment="Center"
                                                FontSize="{DynamicResource STControlFontSize13}"
                                                FontWeight="SemiBold"
                                                Text="{Binding Name}"
                                                TextTrimming="CharacterEllipsis" />

                                            <!--  操作按钮  -->
                                            <Grid Grid.Column="1" Margin="8,0,0,0">
                                                <Button
                                                    MinWidth="50"
                                                    Padding="8,3"
                                                    Command="{Binding Data.DownloadPluginCommand, Source={StaticResource ViewModelProxy}}"
                                                    CommandParameter="{Binding}"
                                                    Content="{Binding ActionStatus, Converter={cnvt:PluginActionStatusToStringConverter}}"
                                                    FontSize="{DynamicResource STControlFontSize11}"
                                                    IsEnabled="{Binding ActionStatus, Converter={cnvt:PluginActionStatusToBoolConverter}}"
                                                    Visibility="{Binding IsDownloading, Converter={cnvt:BoolToVisibilityInverseConverter}}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <!--  默认样式  -->
                                                            <Setter Property="Background" Value="{DynamicResource {x:Static ui:ThemeKeys.ControlFillColorDefaultBrushKey}}" />
                                                            <Setter Property="Foreground" Value="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorPrimaryBrushKey}}" />
                                                            <Setter Property="BorderBrush" Value="{DynamicResource {x:Static ui:ThemeKeys.ControlStrokeColorDefaultBrushKey}}" />
                                                            <Setter Property="BorderThickness" Value="1" />
                                                            <Setter Property="Padding" Value="8,5" />
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border
                                                                            x:Name="Border"
                                                                            Background="{TemplateBinding Background}"
                                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                                            CornerRadius="4">
                                                                            <ContentPresenter
                                                                                Margin="{TemplateBinding Padding}"
                                                                                HorizontalAlignment="Center"
                                                                                VerticalAlignment="Center" />
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource {x:Static ui:ThemeKeys.ControlFillColorSecondaryBrushKey}}" />
                                                                            </Trigger>
                                                                            <Trigger Property="IsPressed" Value="True">
                                                                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource {x:Static ui:ThemeKeys.ControlFillColorTertiaryBrushKey}}" />
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>

                                                            <Style.Triggers>
                                                                <!--  已安装状态  -->
                                                                <DataTrigger Binding="{Binding ActionStatus}" Value="Installed">
                                                                    <Setter Property="IsEnabled" Value="False" />
                                                                    <Setter Property="Opacity" Value="0.6" />
                                                                </DataTrigger>

                                                                <!--  下载状态 - Primary 样式  -->
                                                                <DataTrigger Binding="{Binding ActionStatus}" Value="Download">
                                                                    <Setter Property="Template">
                                                                        <Setter.Value>
                                                                            <ControlTemplate TargetType="Button">
                                                                                <Border
                                                                                    x:Name="Border"
                                                                                    Background="#0078D4"
                                                                                    BorderBrush="#0078D4"
                                                                                    BorderThickness="1"
                                                                                    CornerRadius="4">
                                                                                    <ContentPresenter
                                                                                        Margin="{TemplateBinding Padding}"
                                                                                        HorizontalAlignment="Center"
                                                                                        VerticalAlignment="Center" />
                                                                                </Border>
                                                                                <ControlTemplate.Triggers>
                                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                                        <Setter TargetName="Border" Property="Background" Value="#106EBE" />
                                                                                    </Trigger>
                                                                                    <Trigger Property="IsPressed" Value="True">
                                                                                        <Setter TargetName="Border" Property="Background" Value="#005A9E" />
                                                                                    </Trigger>
                                                                                </ControlTemplate.Triggers>
                                                                            </ControlTemplate>
                                                                        </Setter.Value>
                                                                    </Setter>
                                                                    <Setter Property="Foreground" Value="White" />
                                                                </DataTrigger>

                                                                <!--  升级状态 - 红色警示样式  -->
                                                                <DataTrigger Binding="{Binding ActionStatus}" Value="Upgrade">
                                                                    <Setter Property="Template">
                                                                        <Setter.Value>
                                                                            <ControlTemplate TargetType="Button">
                                                                                <Border
                                                                                    x:Name="Border"
                                                                                    Background="#E74856"
                                                                                    BorderBrush="#E74856"
                                                                                    BorderThickness="1"
                                                                                    CornerRadius="4">
                                                                                    <ContentPresenter
                                                                                        Margin="{TemplateBinding Padding}"
                                                                                        HorizontalAlignment="Center"
                                                                                        VerticalAlignment="Center" />
                                                                                </Border>
                                                                                <ControlTemplate.Triggers>
                                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                                        <Setter TargetName="Border" Property="Background" Value="#F1707A" />
                                                                                    </Trigger>
                                                                                    <Trigger Property="IsPressed" Value="True">
                                                                                        <Setter TargetName="Border" Property="Background" Value="#C42B1C" />
                                                                                    </Trigger>
                                                                                </ControlTemplate.Triggers>
                                                                            </ControlTemplate>
                                                                        </Setter.Value>
                                                                    </Setter>
                                                                    <Setter Property="Foreground" Value="White" />
                                                                </DataTrigger>

                                                                <!--  待重启状态 - 橙色警示样式  -->
                                                                <DataTrigger Binding="{Binding ActionStatus}" Value="PendingRestart">
                                                                    <Setter Property="IsEnabled" Value="False" />
                                                                    <Setter Property="Opacity" Value="0.8" />
                                                                    <Setter Property="Template">
                                                                        <Setter.Value>
                                                                            <ControlTemplate TargetType="Button">
                                                                                <Border
                                                                                    x:Name="Border"
                                                                                    Background="#FF8C00"
                                                                                    BorderBrush="#FF8C00"
                                                                                    BorderThickness="1"
                                                                                    CornerRadius="4">
                                                                                    <ContentPresenter
                                                                                        Margin="{TemplateBinding Padding}"
                                                                                        HorizontalAlignment="Center"
                                                                                        VerticalAlignment="Center" />
                                                                                </Border>
                                                                            </ControlTemplate>
                                                                        </Setter.Value>
                                                                    </Setter>
                                                                    <Setter Property="Foreground" Value="White" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>

                                                <!--  取消按钮  -->
                                                <Button
                                                    MinWidth="50"
                                                    Padding="8,3"
                                                    Command="{Binding Data.CancelDownloadCommand, Source={StaticResource ViewModelProxy}}"
                                                    CommandParameter="{Binding}"
                                                    Content="{DynamicResource Cancel}"
                                                    FontSize="{DynamicResource STControlFontSize11}"
                                                    Visibility="{Binding IsDownloading, Converter={cnvt:BoolToVisibilityConverter}}" />
                                            </Grid>
                                        </Grid>

                                        <!--  描述  -->
                                        <TextBlock
                                            Grid.Row="1"
                                            Margin="0,3,0,0"
                                            FontSize="{DynamicResource STControlFontSize12}"
                                            Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}"
                                            LineHeight="16"
                                            MaxHeight="32"
                                            Text="{Binding Description}"
                                            TextTrimming="CharacterEllipsis"
                                            TextWrapping="Wrap" />

                                        <!--  底部：作者、版本 + 下载进度  -->
                                        <Grid Grid.Row="2" Margin="0,6,0,0">
                                            <!--  作者和版本号  -->
                                            <TextBlock
                                                VerticalAlignment="Center"
                                                FontSize="{DynamicResource STControlFontSize11}"
                                                Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorTertiaryBrushKey}}"
                                                TextTrimming="CharacterEllipsis"
                                                Visibility="{Binding IsDownloading, Converter={cnvt:BoolToVisibilityInverseConverter}}">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0} · v{1}">
                                                        <Binding Path="Author" />
                                                        <Binding Path="Version" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>

                                            <!--  下载进度  -->
                                            <StackPanel VerticalAlignment="Center" Visibility="{Binding IsDownloading, Converter={cnvt:BoolToVisibilityConverter}}">
                                                <ProgressBar
                                                    Height="2"
                                                    Maximum="100"
                                                    Value="{Binding DownloadProgress}" />
                                                <TextBlock
                                                    Margin="0,2,0,0"
                                                    HorizontalAlignment="Right"
                                                    FontSize="{DynamicResource STControlFontSize10}"
                                                    Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}"
                                                    Text="{Binding DownloadStatus}" />
                                            </StackPanel>
                                        </Grid>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!--  底部统计  -->
        <ikw:SimpleStackPanel
            Grid.Row="2"
            Margin="20,10"
            HorizontalAlignment="Center"
            Orientation="Horizontal"
            Spacing="12">
            <ikw:SimpleStackPanel.Resources>
                <Style BasedOn="{StaticResource {x:Type TextBlock}}" TargetType="TextBlock">
                    <Setter Property="Foreground" Value="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}" />
                    <Setter Property="FontSize" Value="{DynamicResource STControlFontSize12}" />
                </Style>
            </ikw:SimpleStackPanel.Resources>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeAll}" />
                <Run Text=": " />
                <Run Text="{Binding TotalPluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeTranslate}" />
                <Run Text=": " />
                <Run Text="{Binding TranslatePluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeOcr}" />
                <Run Text=": " />
                <Run Text="{Binding OcrPluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeTts}" />
                <Run Text=": " />
                <Run Text="{Binding TtsPluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeVocabulary}" />
                <Run Text=": " />
                <Run Text="{Binding VocabularyPluginCount, Mode=OneWay}" />
            </TextBlock>
        </ikw:SimpleStackPanel>

    </Grid>
</ui:Page>
